{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block extra_head %}
{{ block.super }}
{% endblock %}

{% block dashboard_content %}
{% csrf_token %}
<div class="max-w-6xl">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ“‹ ØªØ±ØªÛŒØ¨ Ù†Ù…Ø§ÛŒØ´ Ù…Ù†Ùˆ</h1>
        <p class="text-gray-600">ØªØ±ØªÛŒØ¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ùˆ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø±Ø§ Ø¨Ø§ drag & drop ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯</p>
    </div>

    <div class="bg-white rounded-3xl shadow-lg p-6 md:p-8 space-y-8">
        <!-- Categories Section -->
        <div>
            <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                <span>ğŸ“</span>
                <span>ØªØ±ØªÛŒØ¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</span>
            </h2>
            <p class="text-gray-600 mb-6 text-sm">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§ drag & drop Ø¬Ø§Ø¨Ø¬Ø§ Ú©Ù†ÛŒØ¯</p>
            
            <div id="categories-list" class="space-y-3">
                {% for category_data in categories_data %}
                <div class="category-item bg-gradient-to-r from-indigo-50 to-purple-50 rounded-2xl p-4 border-2 border-indigo-100 cursor-move hover:shadow-lg transition-all" data-category-id="{{ category_data.category.id }}">
                    <div class="flex items-center gap-4">
                        <div class="drag-handle text-2xl text-gray-400 hover:text-indigo-600 transition-colors">
                            â˜°
                        </div>
                        {% if category_data.category.cover_image %}
                        <img src="{{ category_data.category.cover_image.url }}" alt="{{ category_data.category.title }}" 
                             class="w-16 h-16 rounded-xl object-cover border-2 border-white shadow-md">
                        {% else %}
                        <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-indigo-200 to-purple-200 flex items-center justify-center">
                            <span class="text-2xl">ğŸ“</span>
                        </div>
                        {% endif %}
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-900 text-lg">{{ category_data.category.title }}</h3>
                            {% if category_data.category.description %}
                            <p class="text-sm text-gray-600 mt-1">{{ category_data.category.description|truncatewords:10 }}</p>
                            {% endif %}
                        </div>
                        <div class="text-sm text-gray-500 bg-white px-3 py-1 rounded-full">
                            {{ category_data.items|length }} Ù…Ø­ØµÙˆÙ„
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-12 bg-gray-50 rounded-2xl">
                    <span class="text-6xl block mb-4">ğŸ“</span>
                    <p class="text-gray-600">Ù‡Ù†ÙˆØ² Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>
                    <a href="{% url 'dashboard:category_create' %}" class="inline-block mt-4 px-6 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors">
                        Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Items Section -->
        <div class="border-t border-gray-200 pt-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                <span>ğŸ½ï¸</span>
                <span>ØªØ±ØªÛŒØ¨ Ù…Ø­ØµÙˆÙ„Ø§Øª</span>
            </h2>
            <p class="text-gray-600 mb-6 text-sm">Ù…Ø­ØµÙˆÙ„Ø§Øª Ù‡Ø± Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø±Ø§ Ø¨Ø§ drag & drop Ø¬Ø§Ø¨Ø¬Ø§ Ú©Ù†ÛŒØ¯</p>
            
            <div class="space-y-8">
                {% for category_data in categories_data %}
                <div class="category-items-section" data-category-id="{{ category_data.category.id }}">
                    <div class="mb-4 flex items-center gap-3">
                        <h3 class="text-lg font-bold text-gray-800">{{ category_data.category.title }}</h3>
                        <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                            {{ category_data.items|length }} Ù…Ø­ØµÙˆÙ„
                        </span>
                    </div>
                    
                    <div class="items-list-{{ category_data.category.id }} space-y-2">
                        {% for item in category_data.items %}
                        <div class="item-item bg-white rounded-xl p-4 border-2 border-gray-200 hover:border-indigo-300 cursor-move hover:shadow-md transition-all" data-item-id="{{ item.id }}">
                            <div class="flex items-center gap-4">
                                <div class="drag-handle text-xl text-gray-400 hover:text-indigo-600 transition-colors">
                                    â˜°
                                </div>
                                {% if item.primary_image %}
                                <img src="{{ item.primary_image.url }}" alt="{{ item.name }}" 
                                     class="w-14 h-14 rounded-lg object-cover border-2 border-gray-200">
                                {% else %}
                                <div class="w-14 h-14 rounded-lg bg-gray-100 flex items-center justify-center">
                                    <span class="text-xl">ğŸ½ï¸</span>
                                </div>
                                {% endif %}
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900">{{ item.name }}</h4>
                                    <p class="text-xs text-gray-500 mt-1">{{ item.price|floatformat:0 }} ØªÙˆÙ…Ø§Ù†</p>
                                </div>
                                {% if item.is_active %}
                                <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">ÙØ¹Ø§Ù„</span>
                                {% else %}
                                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">ØºÛŒØ±ÙØ¹Ø§Ù„</span>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-8 bg-gray-50 rounded-xl">
                            <p class="text-gray-500 text-sm">Ù…Ø­ØµÙˆÙ„ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Save Button -->
        <div class="pt-6 border-t border-gray-200">
            <button id="save-order-btn" class="w-full md:w-auto px-8 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all font-bold shadow-lg hover:shadow-xl">
                ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªØ±ØªÛŒØ¨ Ù†Ù…Ø§ÛŒØ´
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    // Ensure Sortable is loaded
    if (typeof Sortable === 'undefined') {
        console.error('SortableJS not loaded');
    }
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Sortable for Categories
        const categoriesList = document.getElementById('categories-list');
        if (categoriesList) {
            new Sortable(categoriesList, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'opacity-50',
                chosenClass: 'shadow-lg',
                onEnd: function() {
                    showSaveButton();
                }
            });
        }

        // Initialize Sortable for Items in each category
        document.querySelectorAll('[class^="items-list-"]').forEach(function(itemsList) {
            new Sortable(itemsList, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'opacity-50',
                chosenClass: 'shadow-lg',
                group: 'items',
                onEnd: function() {
                    showSaveButton();
                }
            });
        });

        // Show save button when order changes
        const saveBtn = document.getElementById('save-order-btn');
        let hasChanges = false;

        function showSaveButton() {
            hasChanges = true;
            saveBtn.classList.remove('opacity-50');
            saveBtn.disabled = false;
        }

        // Save order
        saveBtn.addEventListener('click', async function() {
            if (!hasChanges) return;

            const btn = this;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';

            try {
                // Save category order
                const categoryItems = document.querySelectorAll('.category-item');
                const categoryIds = Array.from(categoryItems).map(item => item.dataset.categoryId);

                const categoryResponse = await fetch('{% url "dashboard:update_category_order" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ categories: categoryIds })
                });

                if (!categoryResponse.ok) {
                    throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªØ±ØªÛŒØ¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§');
                }

                // Save item orders for each category
                const categorySections = document.querySelectorAll('.category-items-section');
                for (const section of categorySections) {
                    const categoryId = section.dataset.categoryId;
                    const itemElements = section.querySelectorAll('.item-item');
                    const itemIds = Array.from(itemElements).map(item => item.dataset.itemId);

                    const itemResponse = await fetch('{% url "dashboard:update_item_order" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({
                            category_id: categoryId,
                            items: itemIds
                        })
                    });

                    if (!itemResponse.ok) {
                        throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªØ±ØªÛŒØ¨ Ù…Ø­ØµÙˆÙ„Ø§Øª');
                    }
                }

                // Success
                btn.textContent = 'âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!';
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                hasChanges = false;

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                btn.textContent = 'âŒ Ø®Ø·Ø§: ' + error.message;
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    btn.disabled = false;
                }, 3000);
            }
        });

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Get CSRF token from meta tag or cookie
        function getCSRFToken() {
            const token = document.querySelector('[name=csrfmiddlewaretoken]');
            if (token) return token.value;
            return getCookie('csrftoken');
        }

        // Initially disable save button
        saveBtn.disabled = true;
        saveBtn.classList.add('opacity-50');
    });
</script>
{% endblock %}

